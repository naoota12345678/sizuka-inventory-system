<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIZUKA 統合管理システム</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'メイリオ', Meiryo, 'Hiragino Sans', sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }
        
        /* ヘッダー */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 28px;
            font-weight: bold;
        }
        
        .header-info {
            text-align: right;
        }
        
        .time {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* メインコンテンツ */
        .main-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        /* ナビゲーションタブ */
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: white;
            border: none;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .nav-tab:hover {
            background: #f0f2f5;
        }
        
        .nav-tab.active {
            background: #667eea;
            color: white;
        }
        
        /* タブコンテンツ */
        .tab-content {
            background: white;
            padding: 30px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* ダッシュボードカード */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .dashboard-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        
        .dashboard-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .dashboard-card .value {
            font-size: 32px;
            font-weight: bold;
        }
        
        .dashboard-card .sub-info {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        /* アクションボタン */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
        }
        
        .btn-secondary {
            background: #48bb78;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #38a169;
        }
        
        /* 検索フォーム */
        .search-form {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .search-form h3 {
            margin-bottom: 15px;
            color: #4a5568;
        }
        
        .form-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .form-group label {
            min-width: 100px;
            color: #718096;
        }
        
        .form-group input,
        .form-group select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        /* 結果表示エリア */
        .results-area {
            margin-top: 20px;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .results-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
        }
        
        .results-table tr:hover {
            background: #f7fafc;
        }
        
        /* ステータス表示 */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-success {
            background: #c6f6d5;
            color: #276749;
        }
        
        .status-warning {
            background: #feebc8;
            color: #975a16;
        }
        
        .status-error {
            background: #fed7d7;
            color: #9b2c2c;
        }
        
        /* ローディング */
        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* エラー/成功メッセージ */
        .message {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        
        .message.active {
            display: block;
        }
        
        .message.success {
            background: #c6f6d5;
            color: #276749;
            border: 1px solid #9ae6b4;
        }
        
        .message.error {
            background: #fed7d7;
            color: #9b2c2c;
            border: 1px solid #fc8181;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">SIZUKA 統合管理システム</div>
            <div class="header-info">
                <div class="time" id="currentTime"></div>
                <div>製造・在庫・売上統合管理</div>
            </div>
        </div>
    </div>

    <div class="main-container">
        <!-- ナビゲーションタブ -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('overview')">概要</button>
            <button class="nav-tab" onclick="switchTab('inventory')">在庫管理</button>
            <button class="nav-tab" onclick="switchTab('sales')">売上分析</button>
            <button class="nav-tab" onclick="switchTab('manufacturing')">製造管理</button>
            <button class="nav-tab" onclick="switchTab('integration')">販売連携</button>
            <button class="nav-tab" onclick="switchTab('mapping')">名寄せ管理</button>
        </div>

        <!-- 概要タブ -->
        <div id="overview" class="tab-content active">
            <h2>システム概要</h2>
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3>本日の売上</h3>
                    <div class="value" id="todaySales">¥0</div>
                    <div class="sub-info">前日比: <span id="salesGrowth">0%</span></div>
                </div>
                <div class="dashboard-card">
                    <h3>在庫アラート</h3>
                    <div class="value" id="stockAlerts">0</div>
                    <div class="sub-info">要補充商品数</div>
                </div>
                <div class="dashboard-card">
                    <h3>本日の製造数</h3>
                    <div class="value" id="todayProduction">0</div>
                    <div class="sub-info">製造ライン稼働中</div>
                </div>
                <div class="dashboard-card">
                    <h3>システム状態</h3>
                    <div class="value" id="systemStatus">正常</div>
                    <div class="sub-info">全システム稼働中</div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="refreshDashboard()">ダッシュボード更新</button>
                <button class="btn btn-secondary" onclick="checkSystemStatus()">システム診断</button>
            </div>
            
            <div id="overviewMessage" class="message"></div>
            <div id="systemInfo" class="results-area"></div>
        </div>

        <!-- 在庫管理タブ -->
        <div id="inventory" class="tab-content">
            <h2>在庫管理</h2>
            <div class="search-form">
                <h3>在庫検索</h3>
                <div class="form-group">
                    <label>商品名/コード:</label>
                    <input type="text" id="inventorySearch" placeholder="検索キーワード">
                </div>
                <div class="form-group">
                    <label>フィルター:</label>
                    <select id="inventoryFilter">
                        <option value="">全て表示</option>
                        <option value="low_stock">在庫不足のみ</option>
                        <option value="out_of_stock">在庫切れのみ</option>
                    </select>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="searchInventory()">検索</button>
                    <button class="btn btn-secondary" onclick="exportInventory()">CSVエクスポート</button>
                </div>
            </div>
            
            <div id="inventoryMessage" class="message"></div>
            <div class="loading" id="inventoryLoading">
                <div class="spinner"></div>
                <p>在庫データを取得中...</p>
            </div>
            <div id="inventoryResults" class="results-area"></div>
        </div>

        <!-- 売上分析タブ -->
        <div id="sales" class="tab-content">
            <h2>売上分析</h2>
            <div class="search-form">
                <h3>売上検索</h3>
                <div class="form-group">
                    <label>期間:</label>
                    <input type="date" id="salesStartDate">
                    <span>〜</span>
                    <input type="date" id="salesEndDate">
                </div>
                <div class="form-group">
                    <label>商品名:</label>
                    <input type="text" id="salesProductSearch" placeholder="商品名で検索">
                </div>
                <div class="form-group">
                    <label>並び順:</label>
                    <select id="salesSort">
                        <option value="date">日付順</option>
                        <option value="sales">売上順</option>
                        <option value="units">販売数順</option>
                    </select>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="searchSales()">売上分析</button>
                    <button class="btn btn-secondary" onclick="generateSalesReport()">レポート生成</button>
                </div>
            </div>
            
            <div id="salesMessage" class="message"></div>
            <div class="loading" id="salesLoading">
                <div class="spinner"></div>
                <p>売上データを分析中...</p>
            </div>
            <div id="salesResults" class="results-area"></div>
        </div>

        <!-- 製造管理タブ -->
        <div id="manufacturing" class="tab-content">
            <h2>製造管理</h2>
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3>本日の製造実績</h3>
                    <div class="value" id="todayManufacturing">0個</div>
                    <div class="sub-info">目標: 100個</div>
                </div>
                <div class="dashboard-card">
                    <h3>製造効率</h3>
                    <div class="value" id="efficiency">95%</div>
                    <div class="sub-info">前日比: +2%</div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="viewManufacturingReport()">日報確認</button>
                <button class="btn btn-secondary" onclick="openGoogleForm()">製造データ入力</button>
            </div>
            
            <div id="manufacturingMessage" class="message"></div>
            <div id="manufacturingResults" class="results-area">
                <h3>製造履歴</h3>
                <p>製造データはGoogle Apps Scriptで自動処理されています。</p>
                <p>毎朝8時に前日の製造レポートが自動送信されます。</p>
            </div>
        </div>

        <!-- 販売連携タブ -->
        <div id="integration" class="tab-content">
            <h2>販売プラットフォーム連携</h2>
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3>楽天市場</h3>
                    <div class="value">接続中</div>
                    <div class="sub-info">最終同期: <span id="rakutenLastSync">-</span></div>
                </div>
                <div class="dashboard-card" style="opacity: 0.6;">
                    <h3>Amazon</h3>
                    <div class="value">準備中</div>
                    <div class="sub-info">近日実装予定</div>
                </div>
                <div class="dashboard-card" style="opacity: 0.6;">
                    <h3>ColorME</h3>
                    <div class="value">準備中</div>
                    <div class="sub-info">近日実装予定</div>
                </div>
                <div class="dashboard-card" style="opacity: 0.6;">
                    <h3>エアレジ</h3>
                    <div class="value">準備中</div>
                    <div class="sub-info">売上データ連携予定</div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="syncRakuten()">楽天注文同期</button>
                <button class="btn btn-secondary" onclick="viewSyncHistory()">同期履歴</button>
            </div>
            
            <div id="integrationMessage" class="message"></div>
            <div id="integrationResults" class="results-area"></div>
        </div>

        <!-- 名寄せ管理タブ -->
        <div id="mapping" class="tab-content">
            <h2>商品名寄せ管理</h2>
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3>統合商品数</h3>
                    <div class="value" id="unifiedCount">0</div>
                    <div class="sub-info">統合済み商品</div>
                </div>
                <div class="dashboard-card">
                    <h3>マッピング率</h3>
                    <div class="value" id="mappingCoverage">0%</div>
                    <div class="sub-info">商品カバー率</div>
                </div>
                <div class="dashboard-card">
                    <h3>未マッピング</h3>
                    <div class="value" id="unmappedCount">0</div>
                    <div class="sub-info">要確認商品</div>
                </div>
                <div class="dashboard-card">
                    <h3>重複候補</h3>
                    <div class="value" id="duplicateCount">0</div>
                    <div class="sub-info">統合可能商品</div>
                </div>
            </div>
            
            <div class="search-form">
                <h3>名寄せ確認</h3>
                <div class="form-group">
                    <label>商品名検索:</label>
                    <input type="text" id="mappingSearch" placeholder="商品名で検索">
                </div>
                <div class="form-group">
                    <label>表示オプション:</label>
                    <select id="mappingFilter">
                        <option value="">全て表示</option>
                        <option value="duplicates">重複候補のみ</option>
                        <option value="unmapped">未マッピングのみ</option>
                    </select>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="checkProductMapping()">名寄せ状況確認</button>
                    <button class="btn btn-secondary" onclick="autoDetectDuplicates()">重複自動検出</button>
                </div>
            </div>
            
            <div id="mappingMessage" class="message"></div>
            <div class="loading" id="mappingLoading">
                <div class="spinner"></div>
                <p>名寄せ状況を確認中...</p>
            </div>
            <div id="mappingResults" class="results-area"></div>
        </div>
    </div>

    <script>
        // API設定
        const API_BASE = 'https://sizuka-inventory-system.vercel.app/api';
        
        // 現在時刻の更新
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentTime').textContent = timeStr;
        }
        setInterval(updateTime, 1000);
        updateTime();

        // タブ切り替え
        function switchTab(tabName) {
            // すべてのタブとコンテンツを非アクティブに
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 選択されたタブをアクティブに
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // タブに応じた初期データ読み込み
            if (tabName === 'overview') {
                refreshDashboard();
            }
        }

        // メッセージ表示
        function showMessage(elementId, message, type) {
            const msgElement = document.getElementById(elementId);
            msgElement.textContent = message;
            msgElement.className = `message ${type} active`;
            setTimeout(() => {
                msgElement.classList.remove('active');
            }, 5000);
        }

        // ローディング表示
        function showLoading(elementId, show) {
            const loadingElement = document.getElementById(elementId);
            if (show) {
                loadingElement.classList.add('active');
            } else {
                loadingElement.classList.remove('active');
            }
        }

        // ダッシュボード更新
        async function refreshDashboard() {
            try {
                // 売上データ取得
                const salesResponse = await fetch(`${API_BASE}/sales_search?days=1`);
                const salesData = await salesResponse.json();
                
                if (salesData.status === 'success' && salesData.summary) {
                    document.getElementById('todaySales').textContent = 
                        `¥${salesData.summary.total_sales.toLocaleString()}`;
                }
                
                // 在庫アラート取得
                const inventoryResponse = await fetch(`${API_BASE}/inventory_search?low_stock=true`);
                const inventoryData = await inventoryResponse.json();
                
                if (inventoryData.status === 'success') {
                    document.getElementById('stockAlerts').textContent = 
                        inventoryData.alerts ? inventoryData.alerts.length : 0;
                }
                
                showMessage('overviewMessage', 'ダッシュボードを更新しました', 'success');
            } catch (error) {
                showMessage('overviewMessage', 'データ取得エラー: ' + error.message, 'error');
            }
        }

        // システム診断
        async function checkSystemStatus() {
            try {
                const response = await fetch(`${API_BASE}/system_status`);
                const data = await response.json();
                
                let html = '<h3>システム診断結果</h3>';
                html += '<table class="results-table">';
                html += '<tr><th>テーブル</th><th>状態</th><th>データ有無</th></tr>';
                
                if (data.tables_status) {
                    for (const [table, status] of Object.entries(data.tables_status)) {
                        const statusClass = status.exists ? 'status-success' : 'status-error';
                        const statusText = status.exists ? '正常' : 'エラー';
                        const hasData = status.has_data ? 'あり' : 'なし';
                        
                        html += `<tr>
                            <td>${table}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td>${status.exists ? hasData : '-'}</td>
                        </tr>`;
                    }
                }
                
                html += '</table>';
                document.getElementById('systemInfo').innerHTML = html;
                
            } catch (error) {
                showMessage('overviewMessage', 'システム診断エラー: ' + error.message, 'error');
            }
        }

        // 在庫検索
        async function searchInventory() {
            showLoading('inventoryLoading', true);
            
            try {
                const search = document.getElementById('inventorySearch').value;
                const filter = document.getElementById('inventoryFilter').value;
                
                let url = `${API_BASE}/inventory_search?`;
                if (search) url += `search=${encodeURIComponent(search)}&`;
                if (filter === 'low_stock') url += 'low_stock=true&';
                
                const response = await fetch(url);
                const data = await response.json();
                
                showLoading('inventoryLoading', false);
                
                if (data.status === 'success') {
                    displayInventoryResults(data);
                    showMessage('inventoryMessage', `${data.count}件の商品が見つかりました`, 'success');
                } else {
                    showMessage('inventoryMessage', 'エラー: ' + data.message, 'error');
                }
                
            } catch (error) {
                showLoading('inventoryLoading', false);
                showMessage('inventoryMessage', '検索エラー: ' + error.message, 'error');
            }
        }

        // 在庫結果表示
        function displayInventoryResults(data) {
            let html = '<h3>在庫一覧</h3>';
            
            if (data.alerts && data.alerts.length > 0) {
                html += '<div class="message error active" style="margin-bottom: 20px;">';
                html += `<strong>在庫アラート: ${data.alerts.length}件の商品が要補充です</strong>`;
                html += '</div>';
            }
            
            html += '<table class="results-table">';
            html += '<tr><th>商品コード</th><th>商品名</th><th>現在庫</th><th>最小在庫</th><th>状態</th></tr>';
            
            if (data.items && data.items.length > 0) {
                data.items.forEach(item => {
                    const isLowStock = item.current_stock <= item.minimum_stock;
                    const statusClass = isLowStock ? 'status-warning' : 'status-success';
                    const statusText = isLowStock ? '要補充' : '正常';
                    
                    html += `<tr>
                        <td>${item.product_code}</td>
                        <td>${item.product_name}</td>
                        <td>${item.current_stock}</td>
                        <td>${item.minimum_stock}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    </tr>`;
                });
            }
            
            html += '</table>';
            document.getElementById('inventoryResults').innerHTML = html;
        }

        // 売上検索
        async function searchSales() {
            showLoading('salesLoading', true);
            
            try {
                const startDate = document.getElementById('salesStartDate').value;
                const endDate = document.getElementById('salesEndDate').value;
                const productSearch = document.getElementById('salesProductSearch').value;
                const sortBy = document.getElementById('salesSort').value;
                
                let url = `${API_BASE}/sales_search?`;
                if (startDate) url += `start_date=${startDate}&`;
                if (endDate) url += `end_date=${endDate}&`;
                if (productSearch) url += `product_search=${encodeURIComponent(productSearch)}&`;
                url += `sort_by=${sortBy}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                showLoading('salesLoading', false);
                
                if (data.status === 'success') {
                    displaySalesResults(data);
                    showMessage('salesMessage', '売上データを取得しました', 'success');
                } else {
                    showMessage('salesMessage', 'エラー: ' + data.message, 'error');
                }
                
            } catch (error) {
                showLoading('salesLoading', false);
                showMessage('salesMessage', '検索エラー: ' + error.message, 'error');
            }
        }

        // 売上結果表示
        function displaySalesResults(data) {
            let html = '<h3>売上分析結果</h3>';
            
            if (data.summary) {
                html += '<div class="dashboard-grid" style="margin-bottom: 20px;">';
                html += `<div class="dashboard-card">
                    <h3>合計売上</h3>
                    <div class="value">¥${data.summary.total_sales.toLocaleString()}</div>
                    <div class="sub-info">期間: ${data.summary.period_days}日間</div>
                </div>`;
                html += `<div class="dashboard-card">
                    <h3>販売数</h3>
                    <div class="value">${data.summary.total_units.toLocaleString()}個</div>
                    <div class="sub-info">日平均: ${Math.round(data.summary.avg_daily_sales).toLocaleString()}円</div>
                </div>`;
                html += '</div>';
            }
            
            // トップ商品
            if (data.top_products && data.top_products.length > 0) {
                html += '<h4>売上上位商品</h4>';
                html += '<table class="results-table">';
                html += '<tr><th>商品コード</th><th>商品名</th><th>売上</th><th>販売数</th></tr>';
                
                data.top_products.forEach(product => {
                    html += `<tr>
                        <td>${product.product_code}</td>
                        <td>${product.product_name}</td>
                        <td>¥${product.total_sales.toLocaleString()}</td>
                        <td>${product.total_units}</td>
                    </tr>`;
                });
                
                html += '</table>';
            }
            
            document.getElementById('salesResults').innerHTML = html;
        }

        // その他の関数
        function exportInventory() {
            showMessage('inventoryMessage', 'CSV出力機能は準備中です', 'error');
        }

        function generateSalesReport() {
            showMessage('salesMessage', 'レポート生成機能は準備中です', 'error');
        }

        function viewManufacturingReport() {
            showMessage('manufacturingMessage', '製造レポートはメールで配信されています', 'success');
        }

        function openGoogleForm() {
            showMessage('manufacturingMessage', 'Google Formを開きます（URL設定が必要）', 'error');
        }

        function syncRakuten() {
            window.open('/templates/index.html', '_blank');
        }

        function viewSyncHistory() {
            showMessage('integrationMessage', '同期履歴機能は準備中です', 'error');
        }

        // 名寄せ管理関数
        async function checkProductMapping() {
            showLoading('mappingLoading', true);
            
            try {
                const search = document.getElementById('mappingSearch').value;
                const filter = document.getElementById('mappingFilter').value;
                
                let url = `${API_BASE}/product_mapping_check?`;
                if (search) url += `search=${encodeURIComponent(search)}&`;
                if (filter === 'duplicates') url += 'show_duplicates=true&';
                
                const response = await fetch(url);
                const data = await response.json();
                
                showLoading('mappingLoading', false);
                
                if (data.status === 'success') {
                    // サマリー更新
                    document.getElementById('unifiedCount').textContent = data.summary.unified_products_count;
                    document.getElementById('mappingCoverage').textContent = data.mapping_analysis.mapping_coverage + '%';
                    document.getElementById('unmappedCount').textContent = data.mapping_analysis.unmapped_products.length;
                    document.getElementById('duplicateCount').textContent = data.duplicate_candidates.length;
                    
                    displayMappingResults(data);
                    showMessage('mappingMessage', '名寄せ状況を取得しました', 'success');
                } else {
                    showMessage('mappingMessage', 'エラー: ' + data.message, 'error');
                }
                
            } catch (error) {
                showLoading('mappingLoading', false);
                showMessage('mappingMessage', '取得エラー: ' + error.message, 'error');
            }
        }

        function displayMappingResults(data) {
            let html = '<h3>名寄せ状況詳細</h3>';
            
            // 重複候補
            if (data.duplicate_candidates && data.duplicate_candidates.length > 0) {
                html += '<div class="message warning active" style="margin-bottom: 20px;">';
                html += `<strong>重複候補: ${data.duplicate_candidates.length}件の商品が統合可能です</strong>`;
                html += '</div>';
                
                html += '<h4>重複候補商品</h4>';
                html += '<table class="results-table">';
                html += '<tr><th>商品1</th><th>商品2</th><th>類似度</th><th>操作</th></tr>';
                
                data.duplicate_candidates.forEach(candidate => {
                    html += `<tr>
                        <td>${candidate.product1.code}: ${candidate.product1.name}</td>
                        <td>${candidate.product2.code}: ${candidate.product2.name}</td>
                        <td>${candidate.similarity}%</td>
                        <td><button class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;" 
                            onclick="mergeDuplicates('${candidate.product1.code}', '${candidate.product2.code}')">統合</button></td>
                    </tr>`;
                });
                
                html += '</table>';
            }
            
            // 未マッピング商品
            if (data.mapping_analysis.unmapped_products && data.mapping_analysis.unmapped_products.length > 0) {
                html += '<h4>未マッピング商品</h4>';
                html += '<table class="results-table">';
                html += '<tr><th>商品コード</th><th>商品名</th><th>ソース</th></tr>';
                
                data.mapping_analysis.unmapped_products.slice(0, 20).forEach(product => {
                    html += `<tr>
                        <td>${product.product_code}</td>
                        <td>${product.product_name || '-'}</td>
                        <td>${product.source}</td>
                    </tr>`;
                });
                
                html += '</table>';
            }
            
            // マッピング済み商品
            if (data.mapping_analysis.mapped_products && data.mapping_analysis.mapped_products.length > 0) {
                html += '<h4>マッピング済み商品（サンプル）</h4>';
                html += '<table class="results-table">';
                html += '<tr><th>商品コード</th><th>商品名</th><th>統合コード</th><th>統合名</th></tr>';
                
                data.mapping_analysis.mapped_products.slice(0, 10).forEach(product => {
                    html += `<tr>
                        <td>${product.product_code}</td>
                        <td>${product.product_name}</td>
                        <td>${product.common_code}</td>
                        <td>${product.common_name}</td>
                    </tr>`;
                });
                
                html += '</table>';
            }
            
            document.getElementById('mappingResults').innerHTML = html;
        }

        async function autoDetectDuplicates() {
            showMessage('mappingMessage', '重複検出を開始しています...', 'success');
            await checkProductMapping();
            
            const filter = document.getElementById('mappingFilter');
            filter.value = 'duplicates';
            
            await checkProductMapping();
        }

        function mergeDuplicates(code1, code2) {
            const commonCode = prompt(`統合商品コードを入力してください（例: ${code1}）:`, code1);
            if (!commonCode) return;
            
            const commonName = prompt('統合商品名を入力してください:');
            if (!commonName) return;
            
            // ここで実際のマージ処理を実装
            showMessage('mappingMessage', '統合処理は準備中です', 'error');
        }

        // 初期読み込み
        window.onload = function() {
            refreshDashboard();
        };
    </script>
</body>
</html>