<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIZUKA çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'ãƒ¡ã‚¤ãƒªã‚ª', Meiryo, 'Hiragino Sans', sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 28px;
            font-weight: bold;
        }
        
        .header-info {
            text-align: right;
        }
        
        .time {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .main-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ãƒ– */
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: white;
            border: none;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .nav-tab:hover {
            background: #f0f2f5;
        }
        
        .nav-tab.active {
            background: #667eea;
            color: white;
        }
        
        /* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .tab-content {
            background: white;
            padding: 30px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚«ãƒ¼ãƒ‰ */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .dashboard-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        
        .dashboard-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .dashboard-card .value {
            font-size: 32px;
            font-weight: bold;
        }
        
        .dashboard-card .sub-info {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
        }
        
        .btn-secondary {
            background: #48bb78;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #38a169;
        }
        
        /* æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ  */
        .search-form {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .search-form h3 {
            margin-bottom: 15px;
            color: #4a5568;
        }
        
        .form-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .form-group label {
            min-width: 100px;
            color: #718096;
        }
        
        .form-group input,
        .form-group select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        /* çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .results-area {
            margin-top: 20px;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .results-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
        }
        
        .results-table tr:hover {
            background: #f7fafc;
        }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-success {
            background: #c6f6d5;
            color: #276749;
        }
        
        .status-warning {
            background: #feebc8;
            color: #975a16;
        }
        
        .status-error {
            background: #fed7d7;
            color: #9b2c2c;
        }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ã‚¨ãƒ©ãƒ¼/æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .message {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        
        .message.active {
            display: block;
        }
        
        .message.success {
            background: #c6f6d5;
            color: #276749;
            border: 1px solid #9ae6b4;
        }
        
        .message.error {
            background: #fed7d7;
            color: #9b2c2c;
            border: 1px solid #fc8181;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">SIZUKA çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </div>
            <div class="header-info">
                <div class="time" id="currentTime"></div>
                <div>è£½é€ ãƒ»åœ¨åº«ãƒ»å£²ä¸Šçµ±åˆç®¡ç†</div>
            </div>
        </div>
    </div>

    <div class="main-container">
        <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ãƒ– -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('overview')">æ¦‚è¦</button>
            <button class="nav-tab" onclick="switchTab('inventory')">åœ¨åº«ç®¡ç†</button>
            <button class="nav-tab" onclick="switchTab('sales')">å£²ä¸Šåˆ†æ</button>
            <button class="nav-tab" onclick="switchTab('manufacturing')">è£½é€ ç®¡ç†</button>
            <button class="nav-tab" onclick="switchTab('integration')">è²©å£²é€£æº</button>
            <button class="nav-tab" onclick="switchTab('mapping')">åå¯„ã›ç®¡ç†</button>
        </div>

        <!-- æ¦‚è¦ã‚¿ãƒ– -->
        <div id="overview" class="tab-content active">
            <h2>ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦</h2>
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3>æœ¬æ—¥ã®å£²ä¸Š</h3>
                    <div class="value" id="todaySales">Â¥0</div>
                    <div class="sub-info">å‰æ—¥æ¯”: <span id="salesGrowth">0%</span></div>
                </div>
                <div class="dashboard-card">
                    <h3>åœ¨åº«ã‚¢ãƒ©ãƒ¼ãƒˆ</h3>
                    <div class="value" id="stockAlerts">0</div>
                    <div class="sub-info">è¦è£œå……å•†å“æ•°</div>
                </div>
                <div class="dashboard-card">
                    <h3>æœ¬æ—¥ã®è£½é€ æ•°</h3>
                    <div class="value" id="todayProduction">0</div>
                    <div class="sub-info">è£½é€ ãƒ©ã‚¤ãƒ³ç¨¼åƒä¸­</div>
                </div>
                <div class="dashboard-card">
                    <h3>ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</h3>
                    <div class="value" id="systemStatus">æ­£å¸¸</div>
                    <div class="sub-info">å…¨ã‚·ã‚¹ãƒ†ãƒ ç¨¼åƒä¸­</div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="refreshDashboard()">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°</button>
                <button class="btn btn-secondary" onclick="checkSystemStatus()">ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­</button>
                <button class="btn btn-secondary" onclick="checkSpreadsheetSync()">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆåŒæœŸç¢ºèª</button>
                <button class="btn btn-secondary" onclick="checkInventoryMapping()">åœ¨åº«ãƒãƒƒãƒ”ãƒ³ã‚°ç¢ºèª</button>
            </div>
            
            <div id="overviewMessage" class="message"></div>
            <div id="systemInfo" class="results-area"></div>
        </div>

        <!-- åœ¨åº«ç®¡ç†ã‚¿ãƒ– -->
        <div id="inventory" class="tab-content">
            <h2>åœ¨åº«ç®¡ç†</h2>
            
            <!-- åœ¨åº«ã‚µãƒãƒªãƒ¼ -->
            <div class="dashboard-grid" id="inventorySummary" style="margin-bottom: 20px;">
                <div class="dashboard-card">
                    <h3>ç·å•†å“æ•°</h3>
                    <div class="value" id="totalProducts">0</div>
                    <div class="sub-info">ç™»éŒ²å•†å“</div>
                </div>
                <div class="dashboard-card" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);">
                    <h3>æ­£å¸¸åœ¨åº«</h3>
                    <div class="value" id="normalStock">0</div>
                    <div class="sub-info">é©æ­£åœ¨åº«</div>
                </div>
                <div class="dashboard-card" style="background: linear-gradient(135deg, #f6ad55 0%, #ed8936 100%);">
                    <h3>åœ¨åº«å°‘</h3>
                    <div class="value" id="lowStock">0</div>
                    <div class="sub-info">è¦ç™ºæ³¨</div>
                </div>
                <div class="dashboard-card" style="background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);">
                    <h3>åœ¨åº«åˆ‡ã‚Œ</h3>
                    <div class="value" id="outOfStock">0</div>
                    <div class="sub-info">ç·Šæ€¥å¯¾å¿œ</div>
                </div>
            </div>
            
            <div class="search-form">
                <h3>åœ¨åº«ä¸€è¦§è¡¨ç¤º</h3>
                <div class="form-group">
                    <label>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:</label>
                    <select id="inventoryStatusFilter">
                        <option value="">å…¨ã¦è¡¨ç¤º</option>
                        <option value="normal">æ­£å¸¸åœ¨åº«ã®ã¿</option>
                        <option value="low">åœ¨åº«å°‘ã®ã¿</option>
                        <option value="out">åœ¨åº«åˆ‡ã‚Œã®ã¿</option>
                    </select>
                    <label style="margin-left: 20px;">ä¸¦ã³é †:</label>
                    <select id="inventorySortBy">
                        <option value="common_code">å…±é€šã‚³ãƒ¼ãƒ‰é †</option>
                        <option value="product_name">å•†å“åé †</option>
                        <option value="current_stock">åœ¨åº«æ•°é †</option>
                        <option value="last_updated">æ›´æ–°æ—¥é †</option>
                    </select>
                    <select id="inventorySortOrder">
                        <option value="asc">æ˜‡é †</option>
                        <option value="desc">é™é †</option>
                    </select>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="loadInventoryList()">åœ¨åº«ä¸€è¦§è¡¨ç¤º</button>
                    <button class="btn btn-secondary" onclick="exportInventory()">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                </div>
            </div>
            
            <div id="inventoryMessage" class="message"></div>
            <div class="loading" id="inventoryLoading">
                <div class="spinner"></div>
                <p>åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</p>
            </div>
            <div id="inventoryResults" class="results-area"></div>
            
            <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div id="inventoryPagination" style="text-align: center; margin-top: 20px; display: none;">
                <button class="btn btn-secondary" onclick="changeInventoryPage(-1)">â† å‰ã¸</button>
                <span id="pageInfo" style="margin: 0 20px;">1 / 1</span>
                <button class="btn btn-secondary" onclick="changeInventoryPage(1)">æ¬¡ã¸ â†’</button>
            </div>
        </div>

        <!-- å£²ä¸Šåˆ†æã‚¿ãƒ– -->
        <div id="sales" class="tab-content">
            <h2>å£²ä¸Šåˆ†æ</h2>
            <div class="search-form">
                <h3>å£²ä¸Šæ¤œç´¢</h3>
                <div class="form-group">
                    <label>æœŸé–“:</label>
                    <input type="date" id="salesStartDate">
                    <span>ã€œ</span>
                    <input type="date" id="salesEndDate">
                </div>
                <div class="form-group">
                    <label>å•†å“å:</label>
                    <input type="text" id="salesProductSearch" placeholder="å•†å“åã§æ¤œç´¢">
                </div>
                <div class="form-group">
                    <label>ä¸¦ã³é †:</label>
                    <select id="salesSort">
                        <option value="date">æ—¥ä»˜é †</option>
                        <option value="sales">å£²ä¸Šé †</option>
                        <option value="units">è²©å£²æ•°é †</option>
                    </select>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="searchSales()">å£²ä¸Šåˆ†æ</button>
                    <button class="btn btn-secondary" onclick="generateSalesReport()">ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</button>
                </div>
            </div>
            
            <div id="salesMessage" class="message"></div>
            <div class="loading" id="salesLoading">
                <div class="spinner"></div>
                <p>å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æä¸­...</p>
            </div>
            <div id="salesResults" class="results-area"></div>
        </div>

        <!-- è£½é€ ç®¡ç†ã‚¿ãƒ– -->
        <div id="manufacturing" class="tab-content">
            <h2>è£½é€ ç®¡ç†</h2>
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3>æœ¬æ—¥ã®è£½é€ å®Ÿç¸¾</h3>
                    <div class="value" id="todayManufacturing">0å€‹</div>
                    <div class="sub-info">ç›®æ¨™: 100å€‹</div>
                </div>
                <div class="dashboard-card">
                    <h3>è£½é€ åŠ¹ç‡</h3>
                    <div class="value" id="efficiency">95%</div>
                    <div class="sub-info">å‰æ—¥æ¯”: +2%</div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="viewManufacturingReport()">æ—¥å ±ç¢ºèª</button>
                <button class="btn btn-secondary" onclick="openGoogleForm()">è£½é€ ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</button>
            </div>
            
            <div id="manufacturingMessage" class="message"></div>
            <div id="manufacturingResults" class="results-area">
                <h3>è£½é€ å±¥æ­´</h3>
                <p>è£½é€ ãƒ‡ãƒ¼ã‚¿ã¯Google Apps Scriptã§è‡ªå‹•å‡¦ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
                <p>æ¯æœ8æ™‚ã«å‰æ—¥ã®è£½é€ ãƒ¬ãƒãƒ¼ãƒˆãŒè‡ªå‹•é€ä¿¡ã•ã‚Œã¾ã™ã€‚</p>
            </div>
        </div>

        <!-- è²©å£²é€£æºã‚¿ãƒ– -->
        <div id="integration" class="tab-content">
            <h2>è²©å£²ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ é€£æº</h2>
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3>æ¥½å¤©å¸‚å ´</h3>
                    <div class="value">æ¥ç¶šä¸­</div>
                    <div class="sub-info">æœ€çµ‚åŒæœŸ: <span id="rakutenLastSync">-</span></div>
                </div>
                <div class="dashboard-card" style="opacity: 0.6;">
                    <h3>Amazon</h3>
                    <div class="value">æº–å‚™ä¸­</div>
                    <div class="sub-info">è¿‘æ—¥å®Ÿè£…äºˆå®š</div>
                </div>
                <div class="dashboard-card" style="opacity: 0.6;">
                    <h3>ColorME</h3>
                    <div class="value">æº–å‚™ä¸­</div>
                    <div class="sub-info">è¿‘æ—¥å®Ÿè£…äºˆå®š</div>
                </div>
                <div class="dashboard-card" style="opacity: 0.6;">
                    <h3>ã‚¨ã‚¢ãƒ¬ã‚¸</h3>
                    <div class="value">æº–å‚™ä¸­</div>
                    <div class="sub-info">å£²ä¸Šãƒ‡ãƒ¼ã‚¿é€£æºäºˆå®š</div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="syncRakuten()">æ¥½å¤©æ³¨æ–‡åŒæœŸ</button>
                <button class="btn btn-secondary" onclick="viewSyncHistory()">åŒæœŸå±¥æ­´</button>
            </div>
            
            <div id="integrationMessage" class="message"></div>
            <div id="integrationResults" class="results-area"></div>
        </div>

        <!-- åå¯„ã›ç®¡ç†ã‚¿ãƒ– -->
        <div id="mapping" class="tab-content">
            <h2>å•†å“åå¯„ã›ç®¡ç†</h2>
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3>çµ±åˆå•†å“æ•°</h3>
                    <div class="value" id="unifiedCount">0</div>
                    <div class="sub-info">çµ±åˆæ¸ˆã¿å•†å“</div>
                </div>
                <div class="dashboard-card">
                    <h3>ãƒãƒƒãƒ”ãƒ³ã‚°ç‡</h3>
                    <div class="value" id="mappingCoverage">0%</div>
                    <div class="sub-info">å•†å“ã‚«ãƒãƒ¼ç‡</div>
                </div>
                <div class="dashboard-card">
                    <h3>æœªãƒãƒƒãƒ”ãƒ³ã‚°</h3>
                    <div class="value" id="unmappedCount">0</div>
                    <div class="sub-info">è¦ç¢ºèªå•†å“</div>
                </div>
                <div class="dashboard-card">
                    <h3>é‡è¤‡å€™è£œ</h3>
                    <div class="value" id="duplicateCount">0</div>
                    <div class="sub-info">çµ±åˆå¯èƒ½å•†å“</div>
                </div>
            </div>
            
            <div class="search-form">
                <h3>åå¯„ã›ç¢ºèª</h3>
                <div class="form-group">
                    <label>å•†å“åæ¤œç´¢:</label>
                    <input type="text" id="mappingSearch" placeholder="å•†å“åã§æ¤œç´¢">
                </div>
                <div class="form-group">
                    <label>è¡¨ç¤ºã‚ªãƒ—ã‚·ãƒ§ãƒ³:</label>
                    <select id="mappingFilter">
                        <option value="">å…¨ã¦è¡¨ç¤º</option>
                        <option value="duplicates">é‡è¤‡å€™è£œã®ã¿</option>
                        <option value="unmapped">æœªãƒãƒƒãƒ”ãƒ³ã‚°ã®ã¿</option>
                    </select>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="checkProductMapping()">åå¯„ã›çŠ¶æ³ç¢ºèª</button>
                    <button class="btn btn-secondary" onclick="autoDetectDuplicates()">é‡è¤‡è‡ªå‹•æ¤œå‡º</button>
                </div>
            </div>
            
            <div id="mappingMessage" class="message"></div>
            <div class="loading" id="mappingLoading">
                <div class="spinner"></div>
                <p>åå¯„ã›çŠ¶æ³ã‚’ç¢ºèªä¸­...</p>
            </div>
            <div id="mappingResults" class="results-area"></div>
        </div>
    </div>

    <script>
        // APIè¨­å®š
        const API_BASE = 'https://sizuka-inventory-system-1025485420770.asia-northeast1.run.app/api';
        
        // ç¾åœ¨æ™‚åˆ»ã®æ›´æ–°
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentTime').textContent = timeStr;
        }
        setInterval(updateTime, 1000);
        updateTime();

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tabName) {
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // ã‚¿ãƒ–ã«å¿œã˜ãŸåˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            if (tabName === 'overview') {
                refreshDashboard();
            } else if (tabName === 'inventory') {
                loadInventoryList();
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showMessage(elementId, message, type) {
            const msgElement = document.getElementById(elementId);
            msgElement.textContent = message;
            msgElement.className = `message ${type} active`;
            setTimeout(() => {
                msgElement.classList.remove('active');
            }, 5000);
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        function showLoading(elementId, show) {
            const loadingElement = document.getElementById(elementId);
            if (show) {
                loadingElement.classList.add('active');
            } else {
                loadingElement.classList.remove('active');
            }
        }

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°
        async function refreshDashboard() {
            try {
                // å£²ä¸Šãƒ‡ãƒ¼ã‚¿å–å¾—
                const salesResponse = await fetch(`${API_BASE}/sales_search?days=1`);
                const salesData = await salesResponse.json();
                
                if (salesData.status === 'success' && salesData.summary) {
                    const totalSales = salesData.summary.total_amount || salesData.summary.total_sales || 0;
                    document.getElementById('todaySales').textContent = 
                        `Â¥${totalSales.toLocaleString()}`;
                }
                
                // åœ¨åº«ã‚¢ãƒ©ãƒ¼ãƒˆå–å¾—
                const inventoryResponse = await fetch(`${API_BASE}/inventory_search?low_stock=true`);
                const inventoryData = await inventoryResponse.json();
                
                if (inventoryData.status === 'success') {
                    document.getElementById('stockAlerts').textContent = 
                        inventoryData.alerts ? inventoryData.alerts.length : 0;
                }
                
                showMessage('overviewMessage', 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
            } catch (error) {
                showMessage('overviewMessage', 'ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­
        async function checkSystemStatus() {
            try {
                const response = await fetch(`${API_BASE}/system_status`);
                const data = await response.json();
                
                let html = '<h3>ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­çµæœ</h3>';
                html += '<table class="results-table">';
                html += '<tr><th>ãƒ†ãƒ¼ãƒ–ãƒ«</th><th>çŠ¶æ…‹</th><th>ãƒ‡ãƒ¼ã‚¿æœ‰ç„¡</th></tr>';
                
                if (data.tables_status) {
                    for (const [table, status] of Object.entries(data.tables_status)) {
                        const statusClass = status.exists ? 'status-success' : 'status-error';
                        const statusText = status.exists ? 'æ­£å¸¸' : 'ã‚¨ãƒ©ãƒ¼';
                        const hasData = status.has_data ? 'ã‚ã‚Š' : 'ãªã—';
                        
                        html += `<tr>
                            <td>${table}</td>
                            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td>${status.exists ? hasData : '-'}</td>
                        </tr>`;
                    }
                }
                
                html += '</table>';
                document.getElementById('systemInfo').innerHTML = html;
                
            } catch (error) {
                showMessage('overviewMessage', 'ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // åœ¨åº«ä¸€è¦§ã®ç¾åœ¨ã®ãƒšãƒ¼ã‚¸
        let currentInventoryPage = 1;
        let inventoryData = null;

        // åœ¨åº«ä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadInventoryList() {
            showLoading('inventoryLoading', true);
            
            try {
                const statusFilter = document.getElementById('inventoryStatusFilter').value;
                const sortBy = document.getElementById('inventorySortBy').value;
                const sortOrder = document.getElementById('inventorySortOrder').value;
                
                let url = `${API_BASE}/inventory_list?page=${currentInventoryPage}&per_page=50`;
                if (statusFilter) url += `&status_filter=${statusFilter}`;
                url += `&sort_by=${sortBy}&sort_order=${sortOrder}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                showLoading('inventoryLoading', false);
                
                if (data.status === 'success') {
                    inventoryData = data;
                    updateInventorySummary(data.summary);
                    displayInventoryList(data);
                    updatePagination(data.pagination);
                    showMessage('inventoryMessage', `${data.pagination.total_items}ä»¶ã®å•†å“ã‚’å–å¾—ã—ã¾ã—ãŸ`, 'success');
                } else {
                    showMessage('inventoryMessage', 'ã‚¨ãƒ©ãƒ¼: ' + data.message, 'error');
                }
                
            } catch (error) {
                showLoading('inventoryLoading', false);
                showMessage('inventoryMessage', 'å–å¾—ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // åœ¨åº«ã‚µãƒãƒªãƒ¼æ›´æ–°
        function updateInventorySummary(summary) {
            document.getElementById('totalProducts').textContent = summary.total_products;
            document.getElementById('normalStock').textContent = summary.normal_stock;
            document.getElementById('lowStock').textContent = summary.low_stock;
            document.getElementById('outOfStock').textContent = summary.out_of_stock;
        }

        // åœ¨åº«ä¸€è¦§è¡¨ç¤º
        function displayInventoryList(data) {
            let html = '<h3>åœ¨åº«ä¸€è¦§</h3>';
            
            html += '<table class="results-table">';
            html += '<tr>';
            html += '<th>å…±é€šã‚³ãƒ¼ãƒ‰</th>';
            html += '<th>å•†å“å</th>';
            html += '<th>å†…å®¹é‡</th>';
            html += '<th>ç¾åœ¨åº«</th>';
            html += '<th>åˆæœŸåœ¨åº«</th>';
            html += '<th>æœ€å°åœ¨åº«</th>';
            html += '<th>ä¾¡æ ¼</th>';
            html += '<th>çŠ¶æ…‹</th>';
            html += '<th>æœ€çµ‚æ›´æ–°</th>';
            html += '</tr>';
            
            if (data.items && data.items.length > 0) {
                data.items.forEach(item => {
                    let statusClass = 'status-success';
                    let statusText = 'æ­£å¸¸';
                    
                    if (item.status === 'out_of_stock') {
                        statusClass = 'status-error';
                        statusText = 'åœ¨åº«åˆ‡ã‚Œ';
                    } else if (item.status === 'low_stock') {
                        statusClass = 'status-warning';
                        statusText = 'åœ¨åº«å°‘';
                    }
                    
                    const lastUpdated = item.last_updated ? 
                        new Date(item.last_updated).toLocaleDateString('ja-JP') : '-';
                    
                    html += `<tr>
                        <td>${item.common_code || '-'}</td>
                        <td>${item.product_name}</td>
                        <td>${item.content || '-'}</td>
                        <td style="text-align: right;">${item.current_stock}</td>
                        <td style="text-align: right;">${item.initial_stock || '-'}</td>
                        <td style="text-align: right;">${item.minimum_stock}</td>
                        <td style="text-align: right;">Â¥${item.price ? item.price.toLocaleString() : '-'}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${lastUpdated}</td>
                    </tr>`;
                });
            } else {
                html += '<tr><td colspan="9" style="text-align: center;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
            }
            
            html += '</table>';
            document.getElementById('inventoryResults').innerHTML = html;
        }

        // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°
        function updatePagination(pagination) {
            const pageInfo = document.getElementById('pageInfo');
            pageInfo.textContent = `${pagination.page} / ${pagination.total_pages}`;
            
            const paginationDiv = document.getElementById('inventoryPagination');
            paginationDiv.style.display = pagination.total_pages > 1 ? 'block' : 'none';
        }

        // ãƒšãƒ¼ã‚¸å¤‰æ›´
        function changeInventoryPage(direction) {
            const newPage = currentInventoryPage + direction;
            if (inventoryData && newPage >= 1 && newPage <= inventoryData.pagination.total_pages) {
                currentInventoryPage = newPage;
                loadInventoryList();
            }
        }

        // å£²ä¸Šæ¤œç´¢
        async function searchSales() {
            showLoading('salesLoading', true);
            
            try {
                const startDate = document.getElementById('salesStartDate').value;
                const endDate = document.getElementById('salesEndDate').value;
                const productSearch = document.getElementById('salesProductSearch').value;
                const sortBy = document.getElementById('salesSort').value;
                
                let url = `${API_BASE}/sales_search?`;
                if (startDate) url += `start_date=${startDate}&`;
                if (endDate) url += `end_date=${endDate}&`;
                if (productSearch) url += `product_search=${encodeURIComponent(productSearch)}&`;
                url += `sort_by=${sortBy}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                showLoading('salesLoading', false);
                
                if (data.status === 'success') {
                    displaySalesResults(data);
                    showMessage('salesMessage', 'å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸ', 'success');
                } else {
                    showMessage('salesMessage', 'ã‚¨ãƒ©ãƒ¼: ' + data.message, 'error');
                }
                
            } catch (error) {
                showLoading('salesLoading', false);
                showMessage('salesMessage', 'æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // å£²ä¸Šçµæœè¡¨ç¤º
        function displaySalesResults(data) {
            let html = '<h3>å£²ä¸Šåˆ†æçµæœ</h3>';
            
            if (data.summary) {
                html += '<div class="dashboard-grid" style="margin-bottom: 20px;">';
                html += `<div class="dashboard-card">
                    <h3>åˆè¨ˆå£²ä¸Š</h3>
                    <div class="value">Â¥${(data.summary.total_amount || data.summary.total_sales || 0).toLocaleString()}</div>
                    <div class="sub-info">æœŸé–“: ${data.summary.period_days}æ—¥é–“</div>
                </div>`;
                html += `<div class="dashboard-card">
                    <h3>è²©å£²æ•°</h3>
                    <div class="value">${data.summary.total_units.toLocaleString()}å€‹</div>
                    <div class="sub-info">æ—¥å¹³å‡: ${Math.round(data.summary.avg_daily_sales).toLocaleString()}å††</div>
                </div>`;
                html += '</div>';
            }
            
            // ãƒˆãƒƒãƒ—å•†å“
            if (data.top_products && data.top_products.length > 0) {
                html += '<h4>å£²ä¸Šä¸Šä½å•†å“</h4>';
                html += '<table class="results-table">';
                html += '<tr><th>å•†å“ã‚³ãƒ¼ãƒ‰</th><th>å•†å“å</th><th>å£²ä¸Š</th><th>è²©å£²æ•°</th></tr>';
                
                data.top_products.forEach(product => {
                    html += `<tr>
                        <td>${product.product_code}</td>
                        <td>${product.product_name}</td>
                        <td>Â¥${(product.total_amount || product.total_sales || 0).toLocaleString()}</td>
                        <td>${product.total_units}</td>
                    </tr>`;
                });
                
                html += '</table>';
            }
            
            document.getElementById('salesResults').innerHTML = html;
        }

        // ãã®ä»–ã®é–¢æ•°
        function exportInventory() {
            showMessage('inventoryMessage', 'CSVå‡ºåŠ›æ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™', 'error');
        }

        function generateSalesReport() {
            showMessage('salesMessage', 'ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆæ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™', 'error');
        }

        function viewManufacturingReport() {
            showMessage('manufacturingMessage', 'è£½é€ ãƒ¬ãƒãƒ¼ãƒˆã¯ãƒ¡ãƒ¼ãƒ«ã§é…ä¿¡ã•ã‚Œã¦ã„ã¾ã™', 'success');
        }

        function openGoogleForm() {
            showMessage('manufacturingMessage', 'Google Formã‚’é–‹ãã¾ã™ï¼ˆURLè¨­å®šãŒå¿…è¦ï¼‰', 'error');
        }

        function syncRakuten() {
            window.open('/templates/index.html', '_blank');
        }

        function viewSyncHistory() {
            showMessage('integrationMessage', 'åŒæœŸå±¥æ­´æ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™', 'error');
        }

        // åœ¨åº«ãƒãƒƒãƒ”ãƒ³ã‚°ç¢ºèª
        async function checkInventoryMapping() {
            try {
                const response = await fetch(`${API_BASE}/inventory_mapping_check`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    let html = '<h3>åœ¨åº«ãƒ‡ãƒ¼ã‚¿ãƒãƒƒãƒ”ãƒ³ã‚°çŠ¶æ³</h3>';
                    
                    // ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼è¡¨ç¤º
                    if (data.data_flow && data.data_flow.length > 0) {
                        html += '<h4>ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼</h4>';
                        html += '<table class="results-table">';
                        html += '<tr><th>é †åº</th><th>å‡¦ç†</th><th>ã‚½ãƒ¼ã‚¹</th><th>ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ</th><th>èª¬æ˜</th></tr>';
                        
                        data.data_flow.forEach(flow => {
                            html += `<tr>
                                <td>${flow.step}</td>
                                <td>${flow.process}</td>
                                <td>${flow.source}</td>
                                <td>${flow.target}</td>
                                <td>${flow.description}</td>
                            </tr>`;
                        });
                        
                        html += '</table>';
                    }
                    
                    // åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã®æ‰€åœ¨
                    if (data.inventory_locations) {
                        html += '<h4>åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã®æ‰€åœ¨</h4>';
                        
                        // ç¾åœ¨åœ¨åº«
                        if (data.inventory_locations.current_stock && data.inventory_locations.current_stock.length > 0) {
                            html += '<h5>ğŸ“¦ ç¾åœ¨åœ¨åº«ãƒ‡ãƒ¼ã‚¿</h5>';
                            data.inventory_locations.current_stock.forEach(location => {
                                html += `<p><strong>${location.table}</strong>: ${location.fields.join(', ')}</p>`;
                                html += `<pre style="background: #f5f5f5; padding: 10px; border-radius: 5px; font-size: 12px;">${JSON.stringify(location.sample_value, null, 2)}</pre>`;
                            });
                        }
                        
                        // å•†å“æƒ…å ±
                        if (data.inventory_locations.product_info && data.inventory_locations.product_info.length > 0) {
                            html += '<h5>ğŸ·ï¸ å•†å“æƒ…å ±</h5>';
                            data.inventory_locations.product_info.forEach(location => {
                                html += `<p><strong>${location.table}</strong>: ${location.fields.join(', ')}</p>`;
                                html += `<pre style="background: #f5f5f5; padding: 10px; border-radius: 5px; font-size: 12px;">${JSON.stringify(location.sample_value, null, 2)}</pre>`;
                            });
                        }
                        
                        // å£²ä¸Šãƒ‡ãƒ¼ã‚¿
                        if (data.inventory_locations.sales_data && data.inventory_locations.sales_data.length > 0) {
                            html += '<h5>ğŸ’° å£²ä¸Šãƒ‡ãƒ¼ã‚¿</h5>';
                            data.inventory_locations.sales_data.forEach(location => {
                                html += `<p><strong>${location.table}</strong>: ${location.fields.join(', ')}</p>`;
                                html += `<pre style="background: #f5f5f5; padding: 10px; border-radius: 5px; font-size: 12px;">${JSON.stringify(location.sample_value, null, 2)}</pre>`;
                            });
                        }
                    }
                    
                    // ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ä¸€è¦§
                    if (data.tables) {
                        html += '<h4>ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ä¸€è¦§</h4>';
                        html += '<table class="results-table">';
                        html += '<tr><th>ãƒ†ãƒ¼ãƒ–ãƒ«</th><th>å­˜åœ¨</th><th>ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°</th><th>åœ¨åº«é–¢é€£ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰</th></tr>';
                        
                        for (const [tableName, tableInfo] of Object.entries(data.tables)) {
                            const exists = tableInfo.exists ? 'âœ…' : 'âŒ';
                            const recordCount = tableInfo.record_count || 0;
                            const inventoryFields = tableInfo.inventory_related_fields ? tableInfo.inventory_related_fields.join(', ') : '-';
                            
                            html += `<tr>
                                <td>${tableName}</td>
                                <td>${exists}</td>
                                <td>${recordCount}</td>
                                <td>${inventoryFields}</td>
                            </tr>`;
                        }
                        
                        html += '</table>';
                    }
                    
                    document.getElementById('overviewMessage').className = 'message success active';
                    document.getElementById('overviewMessage').textContent = 'åœ¨åº«ãƒãƒƒãƒ”ãƒ³ã‚°çŠ¶æ³ã‚’å–å¾—ã—ã¾ã—ãŸ';
                    document.getElementById('systemInfo').innerHTML = html;
                    
                } else {
                    showMessage('overviewMessage', 'ã‚¨ãƒ©ãƒ¼: ' + data.message, 'error');
                }
                
            } catch (error) {
                showMessage('overviewMessage', 'ãƒãƒƒãƒ”ãƒ³ã‚°ç¢ºèªã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // å•†å“æ¤œç´¢æ©Ÿèƒ½
        async function traceInventoryData() {
            const searchTerm = prompt('å•†å“åã¾ãŸã¯å•†å“ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (!searchTerm) return;
            
            try {
                const response = await fetch(`${API_BASE}/inventory_data_trace?search_term=${encodeURIComponent(searchTerm)}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    let html = `<h3>ã€Œ${searchTerm}ã€ã®æ¤œç´¢çµæœ</h3>`;
                    
                    if (data.found_in && data.found_in.length > 0) {
                        data.found_in.forEach(result => {
                            if (result.matches) {
                                html += `<h4>${result.table} ãƒ†ãƒ¼ãƒ–ãƒ« (${result.match_count}ä»¶)</h4>`;
                                result.matches.forEach(match => {
                                    html += `<p><strong>ãƒãƒƒãƒãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰:</strong> ${match.matched_field} = "${match.matched_value}"</p>`;
                                    html += `<pre style="background: #f5f5f5; padding: 10px; border-radius: 5px; font-size: 12px;">${JSON.stringify(match.record, null, 2)}</pre>`;
                                });
                            }
                        });
                    } else {
                        html += '<p>è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
                    }
                    
                    document.getElementById('systemInfo').innerHTML = html;
                    showMessage('overviewMessage', `ã€Œ${searchTerm}ã€ã®æ¤œç´¢ãŒå®Œäº†ã—ã¾ã—ãŸ`, 'success');
                } else {
                    showMessage('overviewMessage', 'ã‚¨ãƒ©ãƒ¼: ' + data.message, 'error');
                }
                
            } catch (error) {
                showMessage('overviewMessage', 'æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆåŒæœŸç¢ºèª
        async function checkSpreadsheetSync() {
            try {
                const response = await fetch(`${API_BASE}/spreadsheet_sync_check`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    let html = '<h3>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆåŒæœŸçŠ¶æ³</h3>';
                    
                    // åŒæœŸçŠ¶æ³ã‚µãƒãƒªãƒ¼
                    html += '<div class="dashboard-grid" style="margin-bottom: 20px;">';
                    
                    if (data.sync_status.product_master) {
                        const pm = data.sync_status.product_master;
                        html += `<div class="dashboard-card">
                            <h3>å•†å“ãƒã‚¹ã‚¿ãƒ¼</h3>
                            <div class="value">${pm.total_count}ä»¶</div>
                            <div class="sub-info">å…±é€šã‚³ãƒ¼ãƒ‰ä»˜ã: ${pm.with_common_code}ä»¶ (${pm.mapping_rate}%)</div>
                        </div>`;
                    }
                    
                    if (data.sync_status.unified_products) {
                        const up = data.sync_status.unified_products;
                        html += `<div class="dashboard-card">
                            <h3>çµ±åˆå•†å“</h3>
                            <div class="value">${up.total_count}ä»¶</div>
                            <div class="sub-info">ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚³ãƒ¼ãƒ‰: ${up.unique_common_codes}ä»¶</div>
                        </div>`;
                    }
                    
                    if (data.mapping_stats) {
                        const ms = data.mapping_stats;
                        html += `<div class="dashboard-card">
                            <h3>ãƒãƒƒãƒ”ãƒ³ã‚°ç‡</h3>
                            <div class="value">${ms.coverage_percentage}%</div>
                            <div class="sub-info">æœªãƒãƒƒãƒ”ãƒ³ã‚°: ${ms.unmapped_products}ä»¶</div>
                        </div>`;
                    }
                    
                    html += '</div>';
                    
                    // æœªãƒãƒƒãƒ”ãƒ³ã‚°å•†å“
                    if (data.mapping_stats && data.mapping_stats.unmapped_samples && data.mapping_stats.unmapped_samples.length > 0) {
                        html += '<h4>æœªãƒãƒƒãƒ”ãƒ³ã‚°å•†å“ï¼ˆè¦ç¢ºèªï¼‰</h4>';
                        html += '<table class="results-table">';
                        html += '<tr><th>å•†å“ã‚³ãƒ¼ãƒ‰</th><th>å•†å“å</th><th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th></tr>';
                        
                        data.mapping_stats.unmapped_samples.forEach(item => {
                            html += `<tr>
                                <td>${item.product_code}</td>
                                <td>${item.product_name}</td>
                                <td><button class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;" 
                                    onclick="searchCommonCode('${item.product_code}')">å…±é€šã‚³ãƒ¼ãƒ‰æ¤œç´¢</button></td>
                            </tr>`;
                        });
                        
                        html += '</table>';
                    }
                    
                    document.getElementById('overviewMessage').className = 'message success active';
                    document.getElementById('overviewMessage').textContent = 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆåŒæœŸçŠ¶æ³ã‚’å–å¾—ã—ã¾ã—ãŸ';
                    document.getElementById('systemInfo').innerHTML = html;
                    
                } else {
                    showMessage('overviewMessage', 'ã‚¨ãƒ©ãƒ¼: ' + data.message, 'error');
                }
                
            } catch (error) {
                showMessage('overviewMessage', 'åŒæœŸç¢ºèªã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        async function searchCommonCode(code) {
            try {
                const response = await fetch(`${API_BASE}/common_code_search?code=${encodeURIComponent(code)}`);
                const data = await response.json();
                
                if (data.status === 'success' && data.results.length > 0) {
                    alert(`å…±é€šã‚³ãƒ¼ãƒ‰: ${data.results[0].common_code}\nå…±é€šå: ${data.results[0].common_name}`);
                } else {
                    alert('å…±é€šã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                }
            } catch (error) {
                alert('æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // åå¯„ã›ç®¡ç†é–¢æ•°
        async function checkProductMapping() {
            showLoading('mappingLoading', true);
            
            try {
                const search = document.getElementById('mappingSearch').value;
                const filter = document.getElementById('mappingFilter').value;
                
                let url = `${API_BASE}/product_mapping_check?`;
                if (search) url += `search=${encodeURIComponent(search)}&`;
                if (filter === 'duplicates') url += 'show_duplicates=true&';
                
                const response = await fetch(url);
                const data = await response.json();
                
                showLoading('mappingLoading', false);
                
                if (data.status === 'success') {
                    // ã‚µãƒãƒªãƒ¼æ›´æ–°
                    document.getElementById('unifiedCount').textContent = data.summary.unified_products_count;
                    document.getElementById('mappingCoverage').textContent = data.mapping_analysis.mapping_coverage + '%';
                    document.getElementById('unmappedCount').textContent = data.mapping_analysis.unmapped_products.length;
                    document.getElementById('duplicateCount').textContent = data.duplicate_candidates.length;
                    
                    displayMappingResults(data);
                    showMessage('mappingMessage', 'åå¯„ã›çŠ¶æ³ã‚’å–å¾—ã—ã¾ã—ãŸ', 'success');
                } else {
                    showMessage('mappingMessage', 'ã‚¨ãƒ©ãƒ¼: ' + data.message, 'error');
                }
                
            } catch (error) {
                showLoading('mappingLoading', false);
                showMessage('mappingMessage', 'å–å¾—ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        function displayMappingResults(data) {
            let html = '<h3>åå¯„ã›çŠ¶æ³è©³ç´°</h3>';
            
            // é‡è¤‡å€™è£œ
            if (data.duplicate_candidates && data.duplicate_candidates.length > 0) {
                html += '<div class="message warning active" style="margin-bottom: 20px;">';
                html += `<strong>é‡è¤‡å€™è£œ: ${data.duplicate_candidates.length}ä»¶ã®å•†å“ãŒçµ±åˆå¯èƒ½ã§ã™</strong>`;
                html += '</div>';
                
                html += '<h4>é‡è¤‡å€™è£œå•†å“</h4>';
                html += '<table class="results-table">';
                html += '<tr><th>å•†å“1</th><th>å•†å“2</th><th>é¡ä¼¼åº¦</th><th>æ“ä½œ</th></tr>';
                
                data.duplicate_candidates.forEach(candidate => {
                    html += `<tr>
                        <td>${candidate.product1.code}: ${candidate.product1.name}</td>
                        <td>${candidate.product2.code}: ${candidate.product2.name}</td>
                        <td>${candidate.similarity}%</td>
                        <td><button class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;" 
                            onclick="mergeDuplicates('${candidate.product1.code}', '${candidate.product2.code}')">çµ±åˆ</button></td>
                    </tr>`;
                });
                
                html += '</table>';
            }
            
            // æœªãƒãƒƒãƒ”ãƒ³ã‚°å•†å“
            if (data.mapping_analysis.unmapped_products && data.mapping_analysis.unmapped_products.length > 0) {
                html += '<h4>æœªãƒãƒƒãƒ”ãƒ³ã‚°å•†å“</h4>';
                html += '<table class="results-table">';
                html += '<tr><th>å•†å“ã‚³ãƒ¼ãƒ‰</th><th>å•†å“å</th><th>ã‚½ãƒ¼ã‚¹</th></tr>';
                
                data.mapping_analysis.unmapped_products.slice(0, 20).forEach(product => {
                    html += `<tr>
                        <td>${product.product_code}</td>
                        <td>${product.product_name || '-'}</td>
                        <td>${product.source}</td>
                    </tr>`;
                });
                
                html += '</table>';
            }
            
            // ãƒãƒƒãƒ”ãƒ³ã‚°æ¸ˆã¿å•†å“
            if (data.mapping_analysis.mapped_products && data.mapping_analysis.mapped_products.length > 0) {
                html += '<h4>ãƒãƒƒãƒ”ãƒ³ã‚°æ¸ˆã¿å•†å“ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰</h4>';
                html += '<table class="results-table">';
                html += '<tr><th>å•†å“ã‚³ãƒ¼ãƒ‰</th><th>å•†å“å</th><th>çµ±åˆã‚³ãƒ¼ãƒ‰</th><th>çµ±åˆå</th></tr>';
                
                data.mapping_analysis.mapped_products.slice(0, 10).forEach(product => {
                    html += `<tr>
                        <td>${product.product_code}</td>
                        <td>${product.product_name}</td>
                        <td>${product.common_code}</td>
                        <td>${product.common_name}</td>
                    </tr>`;
                });
                
                html += '</table>';
            }
            
            document.getElementById('mappingResults').innerHTML = html;
        }

        async function autoDetectDuplicates() {
            showMessage('mappingMessage', 'é‡è¤‡æ¤œå‡ºã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...', 'success');
            await checkProductMapping();
            
            const filter = document.getElementById('mappingFilter');
            filter.value = 'duplicates';
            
            await checkProductMapping();
        }

        function mergeDuplicates(code1, code2) {
            const commonCode = prompt(`çµ±åˆå•†å“ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: ${code1}ï¼‰:`, code1);
            if (!commonCode) return;
            
            const commonName = prompt('çµ±åˆå•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (!commonName) return;
            
            // ã“ã“ã§å®Ÿéš›ã®ãƒãƒ¼ã‚¸å‡¦ç†ã‚’å®Ÿè£…
            showMessage('mappingMessage', 'çµ±åˆå‡¦ç†ã¯æº–å‚™ä¸­ã§ã™', 'error');
        }

        // åˆæœŸèª­ã¿è¾¼ã¿
        window.onload = function() {
            refreshDashboard();
        };
    </script>
</body>
</html>