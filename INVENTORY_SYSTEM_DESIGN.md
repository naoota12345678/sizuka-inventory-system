# 楽天注文連動在庫管理システム設計

## システム全体概要

### 基本フロー
```
楽天売上 → 選択肢コード抽出 → 名寄せリスト突合 → 在庫変動
                                     ↓
                              マッピング失敗
                                     ↓
                              未処理売上テーブル → 手動確認 → 在庫変動
```

## データベース構造

### 1. order_items テーブル（既存）
- **用途**: 楽天売上情報のみ保管
- **データ**: 楽天APIから取得した注文データ
- **重要フィールド**: choice_code（選択肢コード）

### 2. 楽天売上→在庫変動テーブル（新規作成）
- **用途**: 楽天売上に対応する在庫減少記録の可視化
- **特徴**: 最終的には不要になる可能性があるが、運用上の可視性のために重要
- **データ**: 処理済みの在庫変動履歴

### 3. 統合在庫リスト（inventory テーブル・既存）
- **用途**: 全プラットフォーム統合の在庫管理
- **更新方法**: 製造した製品を毎日CSVで取り込み
- **確認事項**: CSVインポート機能の実装状況要確認

### 4. 名寄せリスト（新規作成・3つのテーブル）

#### 4-1. 楽天選択肢コードリスト
- **用途**: 選択肢コード（R05, N03等）と実際の商品のマッピング
- **例**: R05 → エゾ鹿レバー30g → 統合在庫ID

#### 4-2. まとめ商品リスト
- **用途**: セット商品（8個入り、10個入り等）の構成管理
- **例**: セット商品A → 商品X×8個 + 商品Y×2個

#### 4-3. 全体用商品リスト
- **用途**: その他のプラットフォーム用商品マッピング

### 5. 未処理売上商品テーブル（新規作成）
- **用途**: 名寄せリストとマッピングできなかった売上商品の一時保管
- **特徴**: 
  - 手動確認・修正用
  - 在庫変動処理後は削除
  - システムの柔軟性を保つための重要な仕組み

## 処理フロー詳細

### ステップ1: 選択肢コード抽出
- **パターン**: 大文字英語1文字 + 数字2桁（R05, N03, etc.）
- **対象**: order_items.choice_code

### ステップ2: 名寄せ処理
1. **選択肢コードリスト**と突合
2. **まとめ商品リスト**と突合（セット商品の場合）
3. マッピング成功 → 在庫変動計算
4. マッピング失敗 → 未処理売上テーブルに保管

### ステップ3: 在庫変動
- **成功例**: R05 → エゾ鹿レバー30g → inventory.current_stock -= 1
- **セット例**: 8個セット → 各構成商品の在庫減少

### ステップ4: 例外処理
- **未処理商品**: 手動確認・名寄せ修正
- **処理完了後**: 未処理テーブルから削除

## スプレッドシート連携

### 管理方法
- **1つのスプレッドシート・3つのタブ**:
  1. 楽天選択肢コードタブ
  2. まとめ商品タブ  
  3. 全体用商品タブ

### 同期仕様
- **頻度**: 1日1回
- **方向**: スプレッドシート → Supabase
- **対象**: 3つの名寄せリストテーブル

## 設計思想

### 柔軟性重視
- **完全自動化を避ける**: システムを固めすぎると運用困難
- **例外処理の組み込み**: 未処理テーブルで手動対応可能
- **段階的処理**: 自動処理 → 例外検出 → 手動確認 → 最終処理

### 可視性重視
- **処理履歴保持**: 在庫変動テーブルで処理状況を可視化
- **未処理リスト**: 対応が必要な商品を明確化

## 実装優先順位
1. 選択肢コード抽出機能の完成
2. 名寄せリストテーブル作成
3. 未処理売上テーブル作成
4. CSVインポート機能確認
5. スプレッドシート連携機能
6. 在庫変動処理機能
7. 例外処理・手動確認機能

## 重要な特徴
- **実用性**: 現実的な業務フローに対応
- **保守性**: 手動介入ポイントを残す
- **拡張性**: 他プラットフォーム対応可能
- **運用性**: 日次バッチ処理との連携