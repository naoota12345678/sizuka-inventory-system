# 🚨 楽天まとめ商品システムの構造的問題分析

## 発見された深刻な問題

### 1. まとめ商品（詰め合わせ）とSKU混在の実態

**問題の核心:**
- 楽天の「まとめ商品」（詰め合わせ商品）の子商品選択肢が、親商品のSKUと混在している
- 単体商品の選択肢コードとまとめ商品の選択肢コードが同一コードを使用している

### 2. 具体的な混在パターン

#### SKU 10000058（ちび袋詰め合わせ）
- **関連選択肢**: 11種類（C01, C06, C15, C04, C18, C19, C16, C17, C05, C08, C22）
- **商品名**: "ちび袋チョイス4個詰め合わせ sizuka エゾ鹿肉"
- **問題**: C01が単体商品（SKUなし）と詰め合わせ商品（SKU有り）で重複使用

#### SKU 10000059（4袋詰め合わせ）
- **関連選択肢**: 55種類（R01-R38まで）
- **商品名**: "選び放題チョイス4袋詰め合わせ シニア ドッグフード ペット"
- **選択肢フォーマット**: "第1袋:R08 ひととき鹿サラミ30g\n第2袋:R20 鹿ハート30g\n..."

#### SKU 10000301（猫用4袋セット）
- **関連選択肢**: 18種類（N01-N10シリーズ）
- **商品名**: "にゃんにゃんチョイス4袋詰め合わせ キャットフード"
- **選択肢フォーマット**: "第1袋:N03鹿サラミチップ10g\n第2袋:N03.鹿サラミチップ10g\n..."

### 3. データ構造の混乱

#### choice_codeフィールドの異常
```
正常な選択肢コード:
- C01（単体）: "C01"

異常な選択肢コード（まとめ商品）:
- "第1袋:C01.エゾ鹿スライス(10g)\n第2袋:C07.ひととき鹿サラミ(10g)\n第3袋:C10.本格馬肉スライス(10g)\n第4袋:C22.ほたて貝柱カットジャーキー(15g)\n配送可能地域は商品詳細をご確認ください:確認済"
```

#### 楽天APIデータの構造的欠陥
1. **選択肢の階層構造が失われている**
   - まとめ商品内の個別選択肢が親商品レベルで記録
   - 選択肢の組み合わせ情報が1つのテキストフィールドに圧縮

2. **SKUの重複割り当て**
   - 1つのSKUに対して最大55種類の異なる選択肢コード
   - 選択肢コードの一意性が担保されていない

### 4. C01の具体的な混乱

**C01（エゾ鹿スライス10g）の現状:**

1. **単体商品として**:
   - 商品名: "ちび袋 エゾ鹿スライスジャーキー 10g"
   - 共通コード: CM096
   - JANコード: 4573265581684
   - SKUコード: なし（選択肢コードのみ）

2. **まとめ商品の一部として**:
   - SKU 10000058内でC01が選択肢として含まれる
   - 詰め合わせ商品の構成要素として重複登録

### 5. システムへの影響

#### マッピングシステムの破綻
```
期待される処理:
C01 → choice_code_mapping → CM096

実際の処理:
C01 → 複数のSKU（10000058等）→ 間違ったマッピング
```

#### 在庫管理の混乱
- 単体商品C01の在庫とまとめ商品内C01の在庫が区別されない
- 廃版SKU 1834への誤ったマッピングの原因

### 6. 楽天APIの根本的設計問題

#### 1. 選択肢の階層構造未対応
- まとめ商品 → 選択肢1, 選択肢2, 選択肢3, 選択肢4
- この階層がフラットなテキストに圧縮される

#### 2. product_codeとrakuten_item_numberの混乱
- `product_code`: まとめ商品のSKU（10000058等）
- `rakuten_item_number`: 不明または不適切な値
- 選択肢コードの取得ロジックが複雑

#### 3. choice_codeフィールドの不適切な使用
- 単純な選択肢コード（"C01"）と複雑な組み合わせ情報の混在
- パース処理の複雑化

## 緊急対応が必要な項目

### 1. C01マッピングの正常化 ✅
- C01 → CM096 の正しいマッピング
- choice_code_mappingテーブルへの登録

### 2. まとめ商品処理ロジックの分離 🔄
- まとめ商品SKUの識別
- 選択肢コード抽出ロジックの改良
- 階層構造の復元処理

### 3. データクレンジング ⏳
- まとめ商品由来の不正データ除去
- 単体商品選択肢との重複解消

## 長期的修正計画

### 1. 楽天APIデータ解析の抜本的見直し
- まとめ商品の検出ロジック
- 選択肢階層の復元アルゴリズム
- SKUと選択肢コードの適切な分離

### 2. マッピングシステムの強化
- まとめ商品専用処理ルート
- 選択肢コード優先のマッピング
- 重複解消メカニズム

### 3. 在庫システムの改良
- 単体商品と詰め合わせ商品の区別
- 構成要素在庫の自動集計
- 整合性チェック機能

## 結論

**楽天まとめ商品システムは、ECサイトの複雑な商品構造をAPIで適切に表現できていない。**

これにより:
- 選択肢コードの重複と混乱
- SKU取り込みロジックの破綻
- マッピングシステムの機能不全
- 在庫管理の不正確性

**根本解決には、楽天APIデータの構造的理解と専用の処理ロジックが必要。**

---

*分析日: 2025-08-21*
*分析対象: order_itemsテーブル（楽天注文データ）*
*発見問題: 選択肢コードとSKUの構造的混在*