# 新しい売上分析システム仕様書

## 📋 概要

既存の在庫システム（98%稼働）を維持したまま、売上分析システムを1から再構築する。
choice_codeマッピングの複雑さを回避し、シンプルで拡張性の高いマルチプラットフォーム対応システムを構築。

## 🎯 基本方針

- **在庫システム**: 現状維持（98%成功で完璧）
- **売上分析**: 完全再構築（楽天APIベース）
- **UI**: 統一ダッシュボードで両方表示

## 🏗️ システム構造

### データソース分離
```
【在庫管理】(既存・維持)
├── choice_code_mapping テーブル (147件)
├── inventory テーブル (44件)
└── 98%マッピング成功

【売上分析】(新規構築)
├── orders テーブル (597件) - 読み取りのみ
├── order_items テーブル (3,068件) - 読み取りのみ
└── platform_daily_sales テーブル (新規作成)
```

## 📊 データベース設計

### platform_daily_sales テーブル
```sql
CREATE TABLE platform_daily_sales (
    sales_date DATE NOT NULL,
    platform VARCHAR(20) NOT NULL,        -- 'rakuten', 'amazon', 'colorme', 'airegi'
    total_amount DECIMAL(12,2) NOT NULL,   -- その日の売上合計
    created_at TIMESTAMP DEFAULT NOW(),
    PRIMARY KEY (sales_date, platform)
);
```

## 🔄 分析ロジック

### A) 金額ベース売上分析
- **データ**: orders + order_items テーブル
- **方法**: 楽天APIデータを直接集計
- **出力**: 期間別売上金額、プラットフォーム別売上
- **マッピング**: 不要（直接集計）

### B) 商品数ベース売れ筋分析
- **データ**: inventory テーブルの在庫変動
- **方法**: 在庫減少数を追跡（既存98%システム活用）
- **出力**: 売れ筋商品ランキング、在庫回転率
- **時系列**: 過去に遡って売れ筋推移を把握

## 🚀 API設計

### /api/sales/platform_summary
期間指定による取引先別売上集計
```json
{
    "period": {"start_date": "2025-07-01", "end_date": "2025-08-01"},
    "total_sales": 15000000,
    "platform_breakdown": {
        "rakuten": 8000000,
        "amazon": 5000000, 
        "colorme": 2000000
    },
    "daily_trends": [
        {"date": "2025-07-01", "total": 500000, "rakuten": 300000, "amazon": 150000}
    ]
}
```

### /api/inventory/trending_products
在庫ベース売れ筋分析
```json
{
    "period": {"start_date": "2025-07-01", "end_date": "2025-08-01"},
    "trending_products": [
        {"common_code": "CM001", "quantity_sold": 206, "rank": 1},
        {"common_code": "CM025", "quantity_sold": 185, "rank": 2}
    ]
}
```

## 🖥️ UI構造

### 売上ダッシュボード
```
├── 【上部】期間選択機能
├── 【左側】金額ベース
│   ├── 総売上金額
│   ├── 取引先別内訳
│   └── 日別推移グラフ
├── 【右側】商品数ベース  
│   ├── 売れ筋ランキング
│   ├── 在庫減少数
│   └── 回転率分析
└── 【下部】統合分析
    └── 金額vs数量の相関
```

## 🌐 マルチプラットフォーム対応

### 対応予定プラットフォーム
1. **楽天**: 既存API連携（最複雑）
2. **Amazon**: API連携予定
3. **カラーミー**: API連携予定
4. **エアレジ**: CSV/Selenium同期

### 拡張方針
- 楽天の仕組みで全て網羅
- 新プラットフォーム追加は簡単（データ投入処理1つ追加）
- データベース構造は統一

## 📈 実装計画

### Phase 1: 基盤構築（楽天データ移行）
1. platform_daily_sales テーブル作成
2. 既存 orders/order_items → 日次集計処理作成
3. API作成: /api/sales/platform_summary
4. UI作成: 期間選択 + 取引先別売上表

### Phase 2: 在庫ベース売れ筋分析
5. API作成: /api/inventory/trending_products
6. UI統合: 売上金額 + 売れ筋数量を並列表示

### Phase 3: 拡張準備
7. Amazon/カラーミー/エアレジ対応

## ⚠️ 安全性確認

### 既存システムへの影響: なし
- **既存テーブル**: 読み取りのみ、変更なし
- **在庫システム**: 完全独立、影響なし
- **既存API**: 変更なし、衝突なし

### リスクレベル: 低
- データ破損リスク: なし
- ロールバック可能性: 高（新規テーブル削除のみ）

## 📝 要件詳細

### 売上表示要件
- **目的**: 取引先別売上集計表（期間指定可能）
- **表示例**: 楽天8,000,000円 + Amazon5,000,000円 = 合計13,000,000円
- **集計**: 日別データからUI側で週別・月別計算
- **詳細**: 各サイトで個別確認（システム側では不要）

### 売れ筋分析要件
- **データソース**: 既存在庫システム（98%稼働中）
- **方法**: 在庫減少数から数量ベースで分析
- **時系列**: 過去に遡って売れ筋推移を把握
- **保管期間**: 5年程度

## ✅ 承認事項

- 2025年8月4日: 仕様確定・実装許可取得
- 既存システムへの影響調査完了
- Phase 1実装開始承認済み

---
最終更新: 2025年8月4日
作成者: Claude (AI Assistant)